## Автоматизация от СмартФабрики

Устройства СмартФабрики используются для построения простых систем автоматизации. Основная концепция систем автоматизации на базе устройств СмартФабрика:

1. **Простота монтажа** - блоки монтируются на DIN рейку и соединяются между собой как кубики конструктора, без каких либо проводов.
2. **Простота программирования** - Arduino совместимый контроллер позволяет реализовать алгоритм автоматизации без погружения в сложные протоколы
3. **Законченный внешний вид** - все устройства выполнены в корпусхах для монтажа на DIN рейку, после сборки получается аккуратная система без лишних проводов и синей изоленты  

Сейчас доступны следующие устройства:

1. **Блок питания**. Мощьность блока питания 18 Вт.
2. **Arduino-совместимый контроллер**. Контроллер выполнен на базе микроконтроллера ATmega328P, имеет в своем составе RTC модуль, интерфейс RS485, два светодиода, USB интерфейс для программирования. Кроме этого, 6 цифровых и 2 аналоговых вывода дополнительно доступны на разъеме расширения. Контроллер совместим с Arduino Nano.
3. **Двухканальный блок реле**. Позволяет управлять силовой нагрузкой. Каждый канал имеет одну группу контактов SPDT.
4. **Двухканальный блок измерения температуры**. Позволяет измерять температуру с помощью внешнего датчика типа DS18B20. 
5. **Двухканальный вход цифровых входов**. Имеет два цифровых входа, и позволяет получать текущее значения со входа, общее число импульсов поступивших на вход и текущую частоту следования импульсов. Примеры применения такого блока: концевые выключатели, кнопки, датчики измерения потока жидкости.
6. **Терминатор сети**. Это пассивный элемент, который устанавливается в конце цепочки устройств на DIN рейке. Используется для терминации сети FabNet. 

![Типовая сборка](https://github.com/sdydykin/FabHome_Arduino/blob/main/img/TypicalSetup.png?raw=true)

## Сеть FabNet

Сеть **FabNet** используется для построени простых систем автоматизации на базе устройств СмартФабрика. Сеть **FabNet**  построена на базе последовательного интерфейса RS485. 

Интерфейс RS485 - это полудуплексный последовательный протокол, использующий одну дифференциальную пару для передачи данных в оба направления. Дифференциальная пара является более помехозащищенным решением по сравнению с обычным проводником.

Основным элементом сети (мастером) является контроллер. Именно контроллер инициирует все обмены по сети (опрос датчиков/реле). 

Датчики и реле являются ведомыми.

Каждый элемент сети (устройство) имеет уникальный идентификатор. По этому идентификатору осуществляется адресация пакетов в сети. Каждое устройство сети имеет переменные через который осуществляется чтение данных с датчиков или управление реле.

Переменные бывают доступные на чтение (датчики) и на запись (реле). Переменные бывают четырех типов:

1. **Вещественная переменная** – хранит значение с плавающей точкой. Размер переменной – 4 байта.
2. **Логическая переменная** – может хранить только два значения: ИСТИНА/ЛОЖЬ или ВКЛЮЧЕНО/ВЫКЛЮЧЕНО. Размер переменной 1 байт.
3. **Целочисленная беззнаковая переменная** – хранит целочисленные значения от 0 до 4294967295.
4. **Целочисленная знаковая переменная** - хранит целочисленные значения от 2147483648 до 2147483647.

![Структура сети](https://github.com/sdydykin/FabHome_Arduino/blob/main/img/NetStructure.png?raw=true)

Например, двухканальный датчик температуры имеет две вещественных переменных с идентификаторами 0x00 и 0x01, которые содержат в себе измеренное значение температуры с нулевого и первого каналов соответственно. Обе переменные доступны только для чтения, то есть являются read  only.

Если рассмотреть блок двухканального реле, то он имеет две логических переменных. Состояние переменной управляет состоянием реле – Включено/Выключено. Переменные блока реле доступны как на запись, так и на чтение.

Другой пример, это блок цифровых входов. Несмотря на то, что блок имеет два входа, он имеет 6 переменных, по три на каждый цифровой вход (переменные с идентификаторами 0x00, 0x01 и 0x02 связаны с нулевым входом, переменные с идентификаторами 0x03, 0x04 и 0x05 связаны с первым входом). Одна переменная логического типа содержит текущее состояние входа – замкнут/разомкнут, вторая переменная содержит общее число импульсов, поступивших на вход, а третья переменная содержит текущую частоту следования импульсов.

## Класс FabNet_Arduino

Для доступа к сети используется класс **FabNet_Arduino**. Методы класса позволяют читать и записывать переменные устройств сети.

Для взаимодействия через RS485 интерфейс используется стандартный класс SoftwareSerial. 

## Методы класса FabNet_Arduino

**1. *FabNet_Arduino*(uint8_t  re_pin, uint8_t  de_pin, uint8_t  ro_pin, uint8_t  di_pin, uint8_t  led_pin)**

Создание экземпляра класса. 

**Параметры:**
**re_pin** - номер пина, к которому подключен сигнал разрешения приемника МС драйвера RS485
**de_pin** - номер пина, к которому подключен сигнал разрешения передатчика МС драйвера RS485 
**ro_pin** -  номер пина, к которому подключен выход приемника МС драйвера RS485 
**di_pin** -  номер пина, к которому подключен вход передатчика МС драйвера RS485  
**led_pin** - номер пина, к которому подключен светодиод индикации сетевой активности

**Возвращаемое значение:** нет 

 **2. void  *begin*(void);**
 
Настройка аппаратной конфигурации. Настраивает аппаратную конфигурацию сетевого интерфейса: настраивает входы/выходы, запускает экземпляр программного последовательного интерфейса (SoftwareSerial)

**Параметры**: нет
**Возвращаемое значение:** нет 

**3. bool  *read_float_var*(uint16_t  dev_id, uint8_t  var_id, float  *  var_val)**

Чтение вещественной переменной из заданного элемента сети.

**Параметры:**
**dev_id** - идентификатор устройства в сети
**var_id** - идентификатор переменной внутри устройства
**var_val** - указатель на переменную, в которую будет скопированно прочитанное значение

**Возвращаемое значение:** статус выполнения запроса. ***True*** - значение переменной успешно прочитано, ***False*** - во время чтения переменной возникла ошибка.

**4. bool  *read_int_var*(uint16_t dev_id, uint8_t  var_id, int32_t  * var_val )**

Чтение целочисленной переменной со знаком из заданного элемента сети.

**Параметры:**
**dev_id** - идентификатор устройства в сети
**var_id** - идентификатор переменной внутри устройства
**var_val** - указатель на переменную, в которую будет скопированно прочитанное значение

**Возвращаемое значение:** статус выполнения запроса. ***True*** - значение переменной успешно прочитано, ***False*** - во время чтения переменной возникла ошибка.

**5. bool  *read_uint_var*(uint16_t  dev_id, uint8_t  var_id, uint32_t  *  var_val)**

Чтение целочисленной перемпенной без знака из заданного элемента сети.

**Параметры:**
**dev_id** - идентификатор устройства в сети
**var_id** - идентификатор переменной внутри устройства
**var_val** - указатель на переменную, в которую будет скопированно прочитанное значение

**Возвращаемое значение:** статус выполнения запроса. ***True*** - значение переменной успешно прочитано, ***False*** - во время чтения переменной возникла ошибка.

**6. bool  *read_bool_var*(uint16_t  dev_id, uint8_t  var_id, bool  *  var_val)**

Чтение логической переменной из заданного элемента сети.

**Параметры:**
**dev_id** - идентификатор устройства в сети
**var_id** - идентификатор переменной внутри устройства
**var_val** - указатель на переменную, в которую будет скопированно прочитанное значение

**Возвращаемое значение:** статус выполнения запроса. ***True*** - значение переменной успешно прочитано, ***False*** - во время чтения переменной возникла ошибка.  

**7. bool  write_bool_var(uint16_t  dev_id, uint8_t  var_id, bool  var_val)**

Запись логической переменной в заданный элемент сети.
  
**Параметры:**
**dev_id** - идентификатор устройства в сети
**var_id** - идентификатор переменной внутри устройства
**var_val** - записываемое значение переменной

**Возвращаемое значение:** статус выполнения записи. ***True*** - значение переменной успешно записано, ***False*** - во время записи переменной возникла ошибка.  

**8. void  set_ctrl_id(uint16_t  ctrl_dev_id)**

Задает идентификатора контроллера в сети FabNet, используется в качестве идентификатора отправителя при работе с элементами сети.

**Параметры:**
**dev_id** - идентификатор контроллера

**Возвращаемое значение:** нет 